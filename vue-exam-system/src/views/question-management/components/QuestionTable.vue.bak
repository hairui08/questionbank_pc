<template>
  <div class="question-table-wrapper">
    <table class="question-table">
      <thead>
        <tr>
          <th width="50">
            <input
              type="checkbox"
              :checked="isAllSelected"
              @change="toggleSelectAll"
            >
          </th>
          <th width="22%">é¢˜ç›®å†…å®¹</th>
          <th width="7%">é¢˜å‹</th>
          <th width="8%">é¡¹ç›®</th>
          <th width="9%">ç§‘ç›®</th>
          <th width="17%">çŸ¥è¯†ç‚¹</th>
          <th width="7%">é¢‘æ¬¡</th>
          <th width="6%">çŠ¶æ€</th>
          <th width="10%">æ“ä½œæ—¶é—´</th>
          <th width="6%">æ“ä½œäºº</th>
          <th width="11%">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr v-if="questions.length === 0">
          <td colspan="11" class="empty-message">
            æš‚æ— è¯•é¢˜æ•°æ®
          </td>
        </tr>
        <tr
          v-for="question in questions"
          :key="question.id"
          :class="{ selected: selectedIds.includes(question.id) }"
        >
          <td>
            <input
              type="checkbox"
              :checked="selectedIds.includes(question.id)"
              @change="toggleSelect(question.id)"
            >
          </td>
          <td class="stem-cell clickable" @click="handleEdit(question.id)">
            <div class="stem-content" :title="`ç‚¹å‡»ç¼–è¾‘è¯•é¢˜: ${question.stem}`">
              {{ truncateStem(question.stem) }}
            </div>
          </td>
          <td>
            <span class="type-badge" :class="`type-${question.type}`">
              {{ getTypeName(question.type) }}
            </span>
          </td>
          <td>{{ getProjectName(question.chapterId) }}</td>
          <td>{{ getSubjectName(question.chapterId) }}</td>
          <td class="knowledge-points-cell">{{ getKnowledgePointNames(question.knowledgePointIds) }}</td>
          <td>
            <span class="frequency-badge" :class="`frequency-${question.frequency}`">
              {{ getFrequencyName(question.frequency) }}
            </span>
          </td>
          <td>
            <span class="status-badge" :class="question.status">
              {{ question.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨' }}
            </span>
          </td>
          <td>{{ formatDateTime(question.createTime) }}</td>
          <td>{{ question.creatorId }}</td>
          <td>
            <ActionDropdown
              :items="getMenuItems(question)"
              trigger-text="æ“ä½œ"
              @select="(key) => handleActionSelect(key, question.id)"
            />
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { Question } from '../types'
import { QuestionTypeNames, QuestionFrequencyNames } from '../types'
import { useProjectStore } from '@/stores/project'
import { useChapterStore } from '@/stores/chapter'
import { useKnowledgePointStore } from '@/stores/knowledgePoint'
import ActionDropdown from '@/components/ActionDropdown.vue'
import type { MenuItem } from '@/components/ActionDropdown.vue'

interface Props {
  questions: Question[]
  selectedIds: string[]
}

interface Emits {
  (e: 'update:selectedIds', value: string[]): void
  (e: 'edit', id: string): void
  (e: 'delete', id: string): void
  (e: 'toggle-status', id: string): void
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

const projectStore = useProjectStore()
const chapterStore = useChapterStore()
const knowledgePointStore = useKnowledgePointStore()

const isAllSelected = computed(() => {
  return props.questions.length > 0 && props.selectedIds.length === props.questions.length
})

function toggleSelectAll(event: Event) {
  const target = event.target as HTMLInputElement
  if (target.checked) {
    emit('update:selectedIds', props.questions.map(q => q.id))
  } else {
    emit('update:selectedIds', [])
  }
}

function toggleSelect(id: string) {
  const newIds = props.selectedIds.includes(id)
    ? props.selectedIds.filter(selectedId => selectedId !== id)
    : [...props.selectedIds, id]
  emit('update:selectedIds', newIds)
}

function truncateStem(stem: string): string {
  return stem.length > 20 ? stem.substring(0, 20) + '...' : stem
}

function getTypeName(type: string): string {
  return QuestionTypeNames[type as keyof typeof QuestionTypeNames] || type
}

function getProjectName(chapterId: string): string {
  const chapter = chapterStore.chapters.find(c => c.id === chapterId)
  if (!chapter) return '-'
  const subject = projectStore.subjects.find(s => s.id === chapter.subjectId)
  if (!subject) return '-'
  const project = projectStore.projects.find(p => p.id === subject.projectId)
  return project?.name || '-'
}

function getSubjectName(chapterId: string): string {
  const chapter = chapterStore.chapters.find(c => c.id === chapterId)
  if (!chapter) return '-'
  const subject = projectStore.subjects.find(s => s.id === chapter.subjectId)
  return subject?.name || '-'
}

function getChapterNameOnly(chapterId: string): string {
  const chapter = chapterStore.chapters.find(c => c.id === chapterId)
  return chapter?.name || '-'
}

function getKnowledgePointNames(knowledgePointIds?: string[]): string {
  if (!knowledgePointIds || knowledgePointIds.length === 0) return '-'
  const names = knowledgePointIds
    .map(id => {
      const kp = knowledgePointStore.getKnowledgePointById(id)
      return kp?.name
    })
    .filter(name => name !== undefined) as string[]
  return names.length > 0 ? names.join('ã€') : '-'
}

function getFrequencyName(frequency?: string): string {
  if (!frequency) return '-'
  return QuestionFrequencyNames[frequency as keyof typeof QuestionFrequencyNames] || frequency
}

function formatDateTime(dateTime: string): string {
  const date = new Date(dateTime)
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')
  const seconds = String(date.getSeconds()).padStart(2, '0')
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
}

function handleEdit(id: string) {
  emit('edit', id)
}

function handleDelete(id: string) {
  emit('delete', id)
}

function handleToggleStatus(id: string) {
  emit('toggle-status', id)
}

/**
 * è·å–æ“ä½œèœå•é¡¹
 */
function getMenuItems(question: Question): MenuItem[] {
  return [
    {
      key: 'edit',
      label: 'ç¼–è¾‘',
      icon: 'âœï¸'
    },
    {
      key: 'toggle',
      label: question.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨',
      icon: question.status === 'active' ? 'ğŸš«' : 'âœ…'
    },
    {
      key: 'delete',
      label: 'åˆ é™¤',
      icon: 'ğŸ—‘ï¸',
      danger: true
    }
  ]
}

/**
 * å¤„ç†èœå•é¡¹é€‰æ‹©
 */
function handleActionSelect(key: string, id: string) {
  switch (key) {
    case 'edit':
      handleEdit(id)
      break
    case 'delete':
      handleDelete(id)
      break
    case 'toggle':
      handleToggleStatus(id)
      break
  }
}
</script>

<style scoped>
.question-table-wrapper {
  background: var(--panel-bg);
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  overflow: hidden;
}

.question-table {
  width: 100%;
  border-collapse: collapse;
}

.question-table thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.question-table th {
  padding: 14px 12px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.question-table tbody tr {
  border-bottom: 1px solid var(--table-border);
  transition: background-color 0.2s ease;
}

.question-table tbody tr:last-child {
  border-bottom: none;
}

.question-table tbody tr:hover {
  background: var(--row-hover);
}

.question-table tbody tr.selected {
  background: #e6f2ff;
}

.question-table td {
  padding: 12px;
  font-size: 14px;
  color: var(--primary-text);
  vertical-align: middle;
}

/* æ“ä½œåˆ—å•å…ƒæ ¼ä¸æ¢è¡Œ */
.question-table td:last-child {
  white-space: nowrap;
}

.empty-message {
  text-align: center;
  padding: 60px 20px !important;
  color: var(--secondary-text);
  font-size: 14px;
}

.stem-cell {
  max-width: 400px;
}

.stem-content {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.knowledge-points-cell {
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--accent);
  font-size: 13px;
}

.type-badge,
.frequency-badge,
.payment-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.type-badge.type-single {
  background: #e3f2fd;
  color: #1976d2;
}

.type-badge.type-multiple {
  background: #f3e5f5;
  color: #7b1fa2;
}

.type-badge.type-judgment {
  background: #e8f5e9;
  color: #388e3c;
}

.type-badge.type-uncertain {
  background: #fff3e0;
  color: #f57c00;
}

.type-badge.type-essay {
  background: #fce4ec;
  color: #c2185b;
}

.type-badge.type-combination {
  background: #e0f2f1;
  color: #00695c;
}

.frequency-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.frequency-low {
  background: #e3f2fd;
  color: #1976d2;
}

.frequency-medium {
  background: #fff3e0;
  color: #f57c00;
}

.frequency-high {
  background: #ffebee;
  color: #c62828;
}

.payment-badge.payment-free {
  background: #f5f5f5;
  color: #616161;
}

.payment-badge.payment-basic {
  background: #e3f2fd;
  color: #1565c0;
}

.payment-badge.payment-premium {
  background: #fff8e1;
  color: #f57f17;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}

.status-badge.active {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #a5d6a7;
}

.status-badge.disabled {
  background: #ffebee;
  color: #c62828;
  border: 1px solid #ef9a9a;
}

/* å¯ç‚¹å‡»çš„é¢˜å¹²å•å…ƒæ ¼ */
.stem-cell.clickable {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

/* é¢˜ç›®å†…å®¹é»˜è®¤æ˜¾ç¤ºè“è‰² */
.stem-cell.clickable .stem-content {
  color: #667eea;
  cursor: pointer;
}

.stem-cell.clickable:hover {
  background-color: #f0f7ff;
}

/* æ‚¬åœæ—¶åªæ·»åŠ ä¸‹åˆ’çº¿ */
.stem-cell.clickable:hover .stem-content {
  text-decoration: underline;
}
</style>
